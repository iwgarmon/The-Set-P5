<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>The Set – Viewfinder / Edit (Auto Orientation)</title>

  <!-- Three.js + controls -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      overflow:hidden;background:#000;color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      user-select:none;-webkit-user-select:none;
      touch-action:none;
    }
    canvas{
      display:block;width:100vw !important;height:100vh !important;
      position:fixed;inset:0;
    }
    .hidden{display:none !important;}
    .ui-interactive{pointer-events:auto;}

    /* ---------- Studio UI ---------- */
    .studio-ui{position:fixed;inset:0;z-index:100;pointer-events:none;}
    .panel{
      pointer-events:auto;
      background:rgba(0,0,0,0.86);
      border:1px solid rgba(255,255,255,0.16);
      backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
      border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,0.45);
    }
    .btn{
      pointer-events:auto;cursor:pointer;
      padding:10px 12px;font-size:11px;font-weight:900;
      letter-spacing:0.8px;text-transform:uppercase;
      border-radius:12px;border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.04);color:#fff;
      transition:transform .08s, background .15s;
    }
    .btn:active{transform:scale(0.96);}
    .btn:hover{background:rgba(255,255,255,0.07);}


    /* ---------- Modals ---------- */
    .modal{
      position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%);
      z-index:220;width:min(90vw,420px);
      max-height:90vh;overflow:auto;pointer-events:auto;
      padding:14px;border-radius:16px;
    }
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .modal-title{font-weight:950;letter-spacing:1px;text-transform:uppercase;font-size:12px;}
    .xbtn{
      pointer-events:auto;font-size:26px;line-height:1;cursor:pointer;
      background:transparent;color:#fff;border:none;padding:0 6px;
    }
    .filmstrip{display:flex;gap:8px;overflow-x:auto;padding:8px 0;}
    .thumb{
      flex:0 0 60px;height:60px;border-radius:10px;
      border:2px solid transparent;overflow:hidden;cursor:pointer;
    }
    .thumb.active{border-color:#ffd64a;}
    .thumb img{width:100%;height:100%;object-fit:cover;}

    /* ---------- Light widget + minimized bar ---------- */
    #light-widget{
      position:fixed;left:12px;bottom:12px;z-index:260;
      width:270px;padding:12px;border-radius:16px;
      display:none;pointer-events:auto;
    }
    #light-widget.show{display:block;}
    #light-widget .label{
      font-size:10px;font-weight:950;letter-spacing:1px;text-transform:uppercase;
      opacity:0.75;margin-bottom:6px;
    }
    #light-widget input[type="range"]{width:100%;}
    #light-widget .row{
      display:flex;align-items:center;justify-content:space-between;margin-top:8px;gap:10px;
    }
    #light-widget .tiny{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-weight:900;opacity:0.75;font-size:11px;
    }

    #light-minibar{
      position:fixed;
      left:12px;
      bottom:12px;
      z-index:255;
      display:none;
      pointer-events:auto;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.82);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      box-shadow:0 10px 24px rgba(0,0,0,0.45);
      font-weight:950;
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:11px;
      color:#ffd64a;
    }
    #light-minibar span{
      color:#fff;opacity:0.7;font-weight:900;letter-spacing:0.2px;text-transform:none;
      margin-left:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    /* ---------- Debug overlay ---------- */
    #debug{
      position:fixed;inset:0;z-index:9999;
      display:none;padding:16px;background:rgba(0,0,0,0.92);
      overflow:auto;pointer-events:auto;
    }
    #debug.show{display:block;}
    #debug pre{
      white-space:pre-wrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;line-height:1.35;
    }
  </style>
</head>

<body>

  <!-- Studio UI -->
  <div class="studio-ui">
    <div style="position:fixed; top:12px; left:12px; pointer-events:none;">
      <div class="panel" style="pointer-events:auto; padding:12px; border-radius:16px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:950; font-size:16px; background:#fff; color:#000; padding:4px 10px; border-radius:10px; letter-spacing:1px; text-transform:uppercase;">
            The Set
          </div>
          <div style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-weight:900; color:#45ff7a;">
            $<span id="balance">500</span>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="btn-ad" class="btn ui-interactive" style="color:#45ff7a;">Watch Ad (+$25)</button>
        </div>
      </div>
    </div>

    <div style="position:fixed; top:12px; right:12px; pointer-events:none;">
      <div class="panel" style="pointer-events:auto; padding:12px; border-radius:16px; display:flex; flex-direction:column; gap:8px; min-width:160px;">
        <div id="fps" style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; opacity:.7; font-size:11px;">
          FPS: --
        </div>
        <button id="btn-gallery" class="btn ui-interactive">Gallery</button>
        <button id="btn-shop" class="btn ui-interactive" style="color:#ffd64a;">Shop</button>
      </div>
    </div>
  </div>

  <!-- Light widget -->
  <div id="light-widget" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div style="font-weight:950;letter-spacing:1px;text-transform:uppercase;font-size:12px;color:#ffd64a;">Light</div>
      <div style="display:flex;gap:8px;">
        <button id="light-min" class="btn ui-interactive" style="padding:6px 10px;font-size:10px;">Min</button>
        <button id="light-close" class="btn ui-interactive" style="padding:6px 10px;font-size:10px;">Close</button>
      </div>
    </div>

    <div class="label">Brightness</div>
    <input id="light-bright" type="range" min="0" max="200" value="100" />
    <div class="row">
      <div class="tiny">0%</div>
      <div class="tiny" id="light-bright-val">100%</div>
      <div class="tiny">200%</div>
    </div>

    <div style="margin-top:10px;" class="label">Color</div>
    <div class="row">
      <input id="light-color" type="color" value="#ffffff" style="width:60px;height:34px;border:none;background:transparent;" />
      <div class="tiny" id="light-color-val">#ffffff</div>
    </div>
  </div>

  <!-- Minimized light bar -->
  <div id="light-minibar" class="ui-interactive">
    LIGHT <span id="light-minitext">tap to reopen</span>
  </div>

  <!-- Gallery modal -->
  <div id="modal-gallery" class="panel modal hidden">
    <div class="modal-head">
      <div class="modal-title">Gallery</div>
      <button class="xbtn ui-interactive" id="close-gallery">&times;</button>
    </div>

    <div style="width:100%; aspect-ratio:3/4; background:#000; border:1px solid rgba(255,255,255,0.16); border-radius:14px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
      <div id="gallery-empty" style="opacity:.35; font-weight:900; letter-spacing:1px; text-transform:uppercase; font-size:11px;">No photos yet</div>
      <img id="gallery-preview" class="hidden" alt="Preview" style="width:100%; height:100%; object-fit:contain;">
    </div>

    <button id="btn-download" class="btn ui-interactive hidden" style="margin-top:10px; background:#fff; color:#000;">Download Photo</button>

    <div style="margin-top:12px; font-size:10px; opacity:.45; font-weight:900; letter-spacing:1px; text-transform:uppercase;">Film Roll</div>
    <div id="filmstrip" class="filmstrip"></div>

    <button id="close-gallery-2" class="btn ui-interactive" style="margin-top:10px;">Close</button>
  </div>

  <!-- Shop modal (Lights + Props) -->
  <div id="modal-shop" class="panel modal hidden">
    <div class="modal-head">
      <div class="modal-title" style="color:#ffd64a;">Shop</div>
      <button class="xbtn ui-interactive" id="close-shop">&times;</button>
    </div>

    <div style="font-size:10px; opacity:.55; font-weight:950; letter-spacing:1px; text-transform:uppercase; margin-bottom:6px;">Lights</div>
    <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:12px;">
      <button class="btn ui-interactive shop-item" data-item="light_small" data-price="60" style="display:flex; justify-content:space-between;">
        <span>Studio Light – Small</span><span style="color:#ffd64a; font-family:ui-monospace;">$60</span>
      </button>
      <button class="btn ui-interactive shop-item" data-item="light_medium" data-price="110" style="display:flex; justify-content:space-between;">
        <span>Studio Light – Medium</span><span style="color:#ffd64a; font-family:ui-monospace;">$110</span>
      </button>
      <button class="btn ui-interactive shop-item" data-item="light_large" data-price="180" style="display:flex; justify-content:space-between;">
        <span>Studio Light – Large</span><span style="color:#ffd64a; font-family:ui-monospace;">$180</span>
      </button>

      <button id="btn-sell-all" class="btn ui-interactive" style="color:#ff5b5b;">
        Sell All Lights (Full Refund)
      </button>
    </div>

    <div style="font-size:10px; opacity:.55; font-weight:950; letter-spacing:1px; text-transform:uppercase; margin-bottom:6px;">Props</div>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button class="btn ui-interactive shop-item" data-item="prop_crate" data-price="20" style="display:flex; justify-content:space-between;">
        <span>Prop – Crate</span><span style="color:#ffd64a; font-family:ui-monospace;">$20</span>
      </button>
      <button class="btn ui-interactive shop-item" data-item="prop_pillar" data-price="35" style="display:flex; justify-content:space-between;">
        <span>Prop – Pillar</span><span style="color:#ffd64a; font-family:ui-monospace;">$35</span>
      </button>
      <button class="btn ui-interactive shop-item" data-item="prop_backdrop" data-price="50" style="display:flex; justify-content:space-between;">
        <span>Prop – Backdrop Panel</span><span style="color:#ffd64a; font-family:ui-monospace;">$50</span>
      </button>
    </div>
  </div>

  <!-- Debug overlay -->
  <div id="debug">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div style="font-weight:950; letter-spacing:1px; text-transform:uppercase;">Crash / Debug</div>
      <button id="debug-close" class="btn ui-interactive">Close</button>
    </div>
    <pre id="debug-text"></pre>
  </div>

  <script>
    /* =========================
       Debug overlay
    ========================= */
    (function(){
      const dbg = document.getElementById('debug');
      const dbgText = document.getElementById('debug-text');
      document.getElementById('debug-close').addEventListener('click', ()=> dbg.classList.remove('show'));
      function show(msg){ dbg.classList.add('show'); dbgText.textContent = msg; }
      window.addEventListener('error', (e)=>{
        show("JS ERROR:\n" + (e.message||"") + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||"") +
             "\n\n" + (e.error && e.error.stack ? e.error.stack : ""));
      });
      window.addEventListener('unhandledrejection', (e)=>{
        show("UNHANDLED PROMISE:\n" + (e.reason && e.reason.stack ? e.reason.stack : String(e.reason)));
      });
    })();

    /* =========================
       Fullscreen (best effort)
    ========================= */
    function requestFullscreenSafe(){
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }
    window.addEventListener('pointerdown', ()=>{ try{ requestFullscreenSafe(); }catch(e){} }, { once:true });

    /* =========================
       App state
    ========================= */
    const APP = {
      scene:null,
      renderer:null,

      studioCamera:null,

      controls:null,
      transformControls:null,

      mode:'studio',
      balance:500,

      selectable:[],
      subject:null,

      studioLights:[],
      props:[],

      edit: {
        selected:null,
        dragging:false,
        dragPlane: new THREE.Plane(new THREE.Vector3(0,1,0), 0),
        dragPoint: new THREE.Vector3(),
        dragOffset: new THREE.Vector3()
      },

      ray: null,
      ndc: null,

      fps: { last: performance.now(), frames:0 },

      lastLightRecord: null
    };

    window.addEventListener('load', init);

    function init(){
      APP.ray = new THREE.Raycaster();
      APP.ndc = new THREE.Vector2();

      initRenderer();
      initCameras();
      initControls();
      initScene();
      initLighting();
      initSubject();
      initUI();

      updateBalance();
      // updateHUD(); // Removed
      updateExposure();

      // applyOrientationMode(true); // Removed
      animate();
    }

    function initRenderer(){
      APP.renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, preserveDrawingBuffer:true });
      APP.renderer.setSize(window.innerWidth, window.innerHeight);
      APP.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      APP.renderer.shadowMap.enabled = true;
      APP.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      APP.renderer.toneMapping = THREE.ACESFilmicToneMapping;
      APP.renderer.toneMappingExposure = 1.0;
      document.body.insertBefore(APP.renderer.domElement, document.body.firstChild);
    }

    function initCameras(){
      const aspect = window.innerWidth / window.innerHeight;

      APP.studioCamera = new THREE.PerspectiveCamera(50, aspect, 0.1, 1000);
      APP.studioCamera.position.set(10, 8, 12);

      // APP.viewCamera = ... // Removed
    }

    function initControls(){
      APP.controls = new THREE.OrbitControls(APP.studioCamera, APP.renderer.domElement);
      APP.controls.enableDamping = true;
      APP.controls.dampingFactor = 0.06;
      APP.controls.target.set(0, 1, 0);
      APP.controls.minDistance = 3.0;
      APP.controls.maxDistance = 35.0;

      APP.transformControls = new THREE.TransformControls(APP.studioCamera, APP.renderer.domElement);
      APP.transformControls.setSpace('world');
      APP.transformControls.setSize(1.3);
      APP.transformControls.setMode('translate');
      APP.transformControls.showY = false;

      APP.transformControls.addEventListener('dragging-changed', (e)=>{
        APP.controls.enabled = !e.value;
      });
      APP.transformControls.addEventListener('objectChange', ()=>{
        clampObjectToFloor(APP.transformControls.object);
        const obj = APP.transformControls.object;
        if (obj && obj.userData && obj.userData.isLight){
          const L = APP.studioLights.find(x=>x.group===obj);
          if (L && L.spotlight){
            L.spotlight.position.set(obj.position.x, 3.2, obj.position.z);
          }
        }
      });
    }

    function initScene(){
      APP.scene = new THREE.Scene();
      APP.scene.background = new THREE.Color(0x0a0a0a);

      APP.scene.add(APP.transformControls);

      const floorSize = 30;
      const floorMat = new THREE.MeshStandardMaterial({ color:0x1a1a1a, roughness:0.9, metalness:0.1 });

      const floor = new THREE.Mesh(new THREE.PlaneGeometry(floorSize, floorSize), floorMat);
      floor.rotation.x = -Math.PI/2;
      floor.receiveShadow = true;
      floor.userData.isFloor = true;
      APP.scene.add(floor);

      const wall = new THREE.Mesh(new THREE.PlaneGeometry(30, 15), floorMat);
      wall.position.set(0, 7.5, -8);
      wall.receiveShadow = true;
      APP.scene.add(wall);

      const curve = new THREE.Mesh(
        new THREE.CylinderGeometry(3,3,30,32,1,true,0,Math.PI/2),
        floorMat
      );
      curve.rotation.z = Math.PI/2;
      curve.position.set(0,3,-5);
      APP.scene.add(curve);
    }

    function initLighting(){
      APP.scene.add(new THREE.AmbientLight(0xffffff, 0.3));

      const key = new THREE.DirectionalLight(0xffffff, 0.9);
      key.position.set(5,10,5);
      key.castShadow = true;
      key.shadow.mapSize.set(1024,1024);
      key.shadow.camera.near = 0.5;
      key.shadow.camera.far = 50;
      key.shadow.camera.left = -10;
      key.shadow.camera.right = 10;
      key.shadow.camera.top = 10;
      key.shadow.camera.bottom = -10;
      APP.scene.add(key);
    }

    function initSubject(){
      APP.subject = createSubject();
      APP.scene.add(APP.subject);
      APP.selectable.push(APP.subject);
      APP.transformControls.attach(APP.subject);
    }

    function createSubject(){
      const g = new THREE.Group();
      g.userData.kind = 'subject';

      const mat = new THREE.MeshStandardMaterial({ color:0x999999, roughness:0.7, metalness:0.1 });
      const dark = new THREE.MeshStandardMaterial({ color:0x222222, roughness:0.8, metalness:0.05 });

      const head = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), mat);
      head.position.y = 1.8;
      head.castShadow = head.receiveShadow = true;

      const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,1.2, 32), mat);
      torso.position.y = 1.0;
      torso.castShadow = torso.receiveShadow = true;

      const base = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.22, 32), dark);
      base.position.y = 0.11;
      base.castShadow = base.receiveShadow = true;

      g.add(head, torso, base);
      clampObjectToFloor(g);
      return g;
    }

    // Orientation and Mode switching removed

    /* =========================
       UI wiring
    ========================= */
    function initUI(){
      document.getElementById('btn-ad').addEventListener('click', watchAd);
      document.getElementById('btn-gallery').addEventListener('click', ()=>openModal('gallery'));
      document.getElementById('btn-shop').addEventListener('click', ()=>openModal('shop'));

      document.getElementById('close-gallery').addEventListener('click', ()=>closeModal('gallery'));
      document.getElementById('close-gallery-2').addEventListener('click', ()=>closeModal('gallery'));
      document.getElementById('close-shop').addEventListener('click', ()=>closeModal('shop'));

      document.getElementById('btn-download').addEventListener('click', downloadPhotoBlob);

      document.querySelectorAll('.shop-item').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const item = btn.dataset.item;
          const price = parseInt(btn.dataset.price, 10);
          buyItem(item, price);
        });
      });
      document.getElementById('btn-sell-all').addEventListener('click', sellAllLights);

      // Edit selection / drag
      const el = APP.renderer.domElement;
      el.addEventListener('pointerdown', onPointerDown);
      el.addEventListener('pointermove', onPointerMove);
      el.addEventListener('pointerup', onPointerUp);
      el.addEventListener('pointercancel', onPointerUp);
      el.addEventListener('pointerleave', onPointerUp);

      // Light widget controls
      document.getElementById('light-close').addEventListener('click', ()=>{
        hideLightWidgetFull();
        hideLightMinibar();
        APP.lastLightRecord = null;
      });
      document.getElementById('light-min').addEventListener('click', minimizeLightWidget);
      document.getElementById('light-bright').addEventListener('input', onLightWidgetChange);
      document.getElementById('light-color').addEventListener('input', onLightWidgetChange);

      document.getElementById('light-minibar').addEventListener('click', ()=>{
        if (APP.lastLightRecord){
          showLightWidgetFor(APP.lastLightRecord);
          hideLightMinibar();
        }
      });

      // Resize/orient
      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', ()=> setTimeout(handleResize, 60));
    }


    /* =========================
       Economy / shop
    ========================= */
    function updateBalance(){
      document.getElementById('balance').textContent = APP.balance;
    }

    function watchAd(){
      const btn = document.getElementById('btn-ad');
      btn.textContent = 'Loading...';
      btn.disabled = true;
      setTimeout(()=>{
        APP.balance += 25;
        updateBalance();
        btn.textContent = 'Watch Ad (+$25)';
        btn.disabled = false;
      }, 900);
    }

    function buyItem(item, price){
      if (APP.balance < price){
        alert('Not enough funds!');
        return;
      }
      APP.balance -= price;
      updateBalance();

      if (item === 'light_small')  addStudioLight('small', price);
      if (item === 'light_medium') addStudioLight('medium', price);
      if (item === 'light_large')  addStudioLight('large', price);

      if (item === 'prop_crate')    addProp('crate', price);
      if (item === 'prop_pillar')   addProp('pillar', price);
      if (item === 'prop_backdrop') addProp('backdrop', price);

      closeModal('shop');
      updateExposure();
    }

    function addStudioLight(size, purchasePrice){
      const presets = {
        small:  { w:0.7, h:0.7, d:0.25, baseIntensity:3.5, distance:18, angle:Math.PI/5 },
        medium: { w:1.0, h:1.0, d:0.30, baseIntensity:5.0, distance:25, angle:Math.PI/4 },
        large:  { w:1.4, h:1.4, d:0.35, baseIntensity:7.5, distance:32, angle:Math.PI/3.5 }
      };
      const p = presets[size] || presets.medium;

      const group = new THREE.Group();
      group.userData.isLight = true;
      group.userData.kind = 'light';
      group.userData.purchasePrice = purchasePrice;

      group.position.set(3 + Math.random()*2, 0, 2 + Math.random()*2);

      const housing = new THREE.Mesh(
        new THREE.BoxGeometry(p.w, p.h, p.d),
        new THREE.MeshStandardMaterial({ color:0x070707, roughness:0.7, metalness:0.1 })
      );
      housing.castShadow = true;
      housing.receiveShadow = true;
      group.add(housing);

      const face = new THREE.Mesh(
        new THREE.PlaneGeometry(p.w*0.9, p.h*0.9),
        new THREE.MeshBasicMaterial({ color:0xffffff })
      );
      face.position.z = p.d/2 + 0.01;
      housing.add(face);

      const spot = new THREE.SpotLight(0xffffff, p.baseIntensity, p.distance, p.angle, 0.35);
      spot.position.set(group.position.x, 3.2, group.position.z);
      spot.castShadow = true;

      const target = new THREE.Object3D();
      target.position.set(APP.subject.position.x, 1.0, APP.subject.position.z);
      APP.scene.add(target);
      spot.target = target;

      APP.scene.add(group);
      APP.scene.add(spot);

      clampObjectToFloor(group);

      const record = {
        group,
        spotlight: spot,
        target,
        baseIntensity: p.baseIntensity,
        purchasePrice,
        userIntensity: 1.0,
        userColor: '#ffffff'
      };

      APP.studioLights.push(record);
      APP.selectable.push(group);

      APP.transformControls.attach(group);
      APP.lastLightRecord = record;
      showLightWidgetFor(record);
      hideLightMinibar();

      updateExposure();
    }

    function addProp(kind, purchasePrice){
      const group = new THREE.Group();
      group.userData.isProp = true;
      group.userData.kind = 'prop';
      group.userData.propKind = kind;
      group.userData.purchasePrice = purchasePrice;

      group.position.set(-2 + Math.random()*4, 0, -1 + Math.random()*4);

      const mat = new THREE.MeshStandardMaterial({ color:0x444444, roughness:0.85, metalness:0.05 });
      const mat2 = new THREE.MeshStandardMaterial({ color:0x222222, roughness:0.9, metalness:0.02 });

      let mesh;

      if (kind === 'crate'){
        mesh = new THREE.Mesh(new THREE.BoxGeometry(0.9,0.9,0.9), mat);
        mesh.position.y = 0.45;
      } else if (kind === 'pillar'){
        mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,1.8,32), mat);
        mesh.position.y = 0.9;
      } else {
        mesh = new THREE.Mesh(new THREE.BoxGeometry(4.0,2.5,0.08), mat2);
        mesh.position.y = 1.25;
        mesh.position.z = -2.5;
      }

      mesh.castShadow = true;
      mesh.receiveShadow = true;
      group.add(mesh);

      APP.scene.add(group);
      APP.props.push({ group, purchasePrice });
      APP.selectable.push(group);

      clampObjectToFloor(group);
      APP.transformControls.attach(group);

      if (APP.lastLightRecord){
        minimizeLightWidget();
      }
    }

    function sellAllLights(){
      let refund = 0;

      APP.selectable = APP.selectable.filter(obj=>{
        if (obj && obj.userData && obj.userData.isLight){
          refund += obj.userData.purchasePrice || 0;
          APP.scene.remove(obj);
          return false;
        }
        return true;
      });

      APP.studioLights.forEach(L=>{
        if (L.spotlight) APP.scene.remove(L.spotlight);
        if (L.target) APP.scene.remove(L.target);
      });
      APP.studioLights = [];

      APP.balance += refund;
      updateBalance();

      hideLightWidgetFull();
      hideLightMinibar();
      APP.lastLightRecord = null;

      closeModal('shop');
      updateExposure();
    }

    /* =========================
       Light widget minimize / show
    ========================= */
    function showLightWidgetFor(L){
      const w = document.getElementById('light-widget');
      w.classList.add('show');

      const bright = document.getElementById('light-bright');
      const color = document.getElementById('light-color');
      const bval = document.getElementById('light-bright-val');
      const cval = document.getElementById('light-color-val');

      const pct = Math.round((L.userIntensity || 1.0) * 100);
      bright.value = String(clampInt(pct, 0, 200));
      bval.textContent = bright.value + '%';

      color.value = L.userColor || '#ffffff';
      cval.textContent = color.value.toLowerCase();

      APP._activeLightRecord = L;

      document.getElementById('light-minitext').textContent = `${bright.value}%`;
    }

    function onLightWidgetChange(){
      const L = APP._activeLightRecord;
      if (!L) return;

      const bright = document.getElementById('light-bright');
      const color = document.getElementById('light-color');

      document.getElementById('light-bright-val').textContent = bright.value + '%';
      document.getElementById('light-color-val').textContent = color.value.toLowerCase();
      document.getElementById('light-minitext').textContent = `${bright.value}%`;

      L.userIntensity = parseInt(bright.value, 10) / 100;
      L.userColor = color.value;

      updateExposure();
    }

    function minimizeLightWidget(){
      hideLightWidgetFull();
      if (APP.lastLightRecord){
        showLightMinibar();
      }
    }

    function hideLightWidgetFull(){
      document.getElementById('light-widget').classList.remove('show');
      APP._activeLightRecord = null;
    }

    function showLightMinibar(){
      document.getElementById('light-minibar').style.display = 'block';
    }

    function hideLightMinibar(){
      document.getElementById('light-minibar').style.display = 'none';
    }

    /* =========================
       Exposure (Simplified)
    ========================= */
    function updateExposure(){
      const exposure = 1.0;
      APP.renderer.toneMappingExposure = exposure;

      // studio lights scale with exposure + widget intensity/color
      APP.studioLights.forEach(L=>{
        if (!L.spotlight) return;
        const mult = (L.userIntensity || 1.0);
        L.spotlight.intensity = Math.max(0.0, L.baseIntensity * exposure * mult);
        if (L.userColor) L.spotlight.color.set(L.userColor);
      });
    }

    /* =========================
       Photos + gallery
    ========================= */
    function takePhoto(){ /* No-op in Studio */ }

    function updateGallery(){
      const film = document.getElementById('filmstrip');
      const preview = document.getElementById('gallery-preview');
      const empty = document.getElementById('gallery-empty');
      const dl = document.getElementById('btn-download');

      film.innerHTML = '';

      if (APP.photos.length === 0){
        empty.classList.remove('hidden');
        preview.classList.add('hidden');
        dl.classList.add('hidden');
        return;
      }

      empty.classList.add('hidden');
      preview.classList.remove('hidden');
      dl.classList.remove('hidden');

      preview.src = APP.photos[APP.activePhoto];

      APP.photos.forEach((p, i)=>{
        const div = document.createElement('div');
        div.className = 'thumb' + (i===APP.activePhoto ? ' active' : '');
        div.innerHTML = `<img src="${p}" alt="photo">`;
        div.addEventListener('click', ()=>{
          APP.activePhoto = i;
          updateGallery();
        });
        film.appendChild(div);
      });
    }

    async function downloadPhotoBlob(){
      if (APP.activePhoto < 0 || APP.activePhoto >= APP.photos.length) return;
      const dataURL = APP.photos[APP.activePhoto];

      const blob = dataURLToBlob(dataURL);
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `the-set-${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    function dataURLToBlob(dataURL){
      const [meta, b64] = dataURL.split(',');
      const mime = (meta.match(/data:(.*);base64/)||[])[1] || 'image/png';
      const bin = atob(b64);
      const len = bin.length;
      const bytes = new Uint8Array(len);
      for (let i=0; i<len; i++) bytes[i] = bin.charCodeAt(i);
      return new Blob([bytes], { type: mime });
    }

    /* =========================
       Modals
    ========================= */
    function openModal(name){
      closeAllModals();
      const el = document.getElementById('modal-'+name);
      if (!el) return;
      el.classList.remove('hidden');
      if (name === 'gallery') updateGallery();
    }
    function closeModal(name){
      document.getElementById('modal-'+name)?.classList.add('hidden');
    }
    function closeAllModals(){
      ['gallery','shop'].forEach(closeModal);
    }

    /* =========================
       Edit mode selection & dragging
    ========================= */
    function setNDC(ev){
      const rect = APP.renderer.domElement.getBoundingClientRect();
      APP.ndc.x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;
      APP.ndc.y = -((ev.clientY - rect.top) / rect.height) * 2 + 1;
    }

    function raycastSelectable(ev){
      setNDC(ev);
      APP.ray.setFromCamera(APP.ndc, APP.studioCamera);
      return APP.ray.intersectObjects(APP.selectable, true);
    }

    function pickRoot(obj){
      while (obj.parent && !APP.selectable.includes(obj)) obj = obj.parent;
      return obj;
    }

    function onPointerDown(ev){
      if (APP.mode !== 'studio') return;
      if (ev.target.closest && ev.target.closest('.ui-interactive')) return;

      const hits = raycastSelectable(ev);
      if (hits.length){
        const root = pickRoot(hits[0].object);
        if (APP.selectable.includes(root)){
          APP.edit.selected = root;
          APP.transformControls.attach(root);

          if (root.userData && root.userData.isLight){
            const L = APP.studioLights.find(x=>x.group===root);
            if (L){
              APP.lastLightRecord = L;
              showLightWidgetFor(L);
              hideLightMinibar();
            }
          } else {
            if (APP.lastLightRecord){
              minimizeLightWidget();
            } else {
              hideLightWidgetFull();
              hideLightMinibar();
            }
          }

          setNDC(ev);
          APP.ray.setFromCamera(APP.ndc, APP.studioCamera);
          const hit = APP.ray.ray.intersectPlane(APP.edit.dragPlane, APP.edit.dragPoint);
          if (hit){
            APP.edit.dragging = true;
            APP.edit.dragOffset.copy(root.position).sub(APP.edit.dragPoint);
            APP.controls.enabled = false;
          }
        }
      } else {
        APP.edit.selected = null;
        APP.transformControls.detach();
        if (APP.lastLightRecord){
          minimizeLightWidget();
        } else {
          hideLightWidgetFull();
          hideLightMinibar();
        }
      }
    }

    function onPointerMove(ev){
      if (APP.mode !== 'studio') return;
      if (!APP.edit.dragging || !APP.edit.selected) return;

      setNDC(ev);
      APP.ray.setFromCamera(APP.ndc, APP.studioCamera);
      const hit = APP.ray.ray.intersectPlane(APP.edit.dragPlane, APP.edit.dragPoint);
      if (!hit) return;

      APP.edit.selected.position.copy(APP.edit.dragPoint).add(APP.edit.dragOffset);
      clampObjectToFloor(APP.edit.selected);

      if (APP.edit.selected.userData && APP.edit.selected.userData.isLight){
        const L = APP.studioLights.find(x=>x.group===APP.edit.selected);
        if (L && L.spotlight){
          L.spotlight.position.set(APP.edit.selected.position.x, 3.2, APP.edit.selected.position.z);
        }
      }
    }

    function onPointerUp(){
      if (APP.mode !== 'studio') return;
      APP.edit.dragging = false;
      APP.controls.enabled = true;
    }

    /* =========================
       Helpers
    ========================= */
    function clampObjectToFloor(obj){
      if (!obj) return;
      const box = new THREE.Box3().setFromObject(obj);
      const minY = box.min.y;
      if (minY < 0) obj.position.y += (-minY);
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function clampInt(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function handleResize(){
      const w = window.innerWidth, h = window.innerHeight;
      APP.renderer.setSize(w,h);

      APP.studioCamera.aspect = w/h;
      APP.studioCamera.updateProjectionMatrix();
    }

    /* =========================
       Main loop
    ========================= */
    function animate(){
      requestAnimationFrame(animate);

      APP.controls.target.y = Math.max(0.6, APP.controls.target.y);
      APP.studioCamera.position.y = Math.max(0.6, APP.studioCamera.position.y);
      APP.controls.update();

      const now = performance.now();
      APP.fps.frames++;
      if (now - APP.fps.last >= 500){
        const fps = Math.round((APP.fps.frames * 1000) / (now - APP.fps.last));
        const el = document.getElementById('fps');
        if (el) el.textContent = `FPS: ${fps}`;
        APP.fps.frames = 0;
        APP.fps.last = now;
      }

      APP.renderer.render(APP.scene, APP.studioCamera);
    }

    document.getElementById('close-gallery').addEventListener('click', ()=>closeModal('gallery'));
    document.getElementById('close-gallery-2').addEventListener('click', ()=>closeModal('gallery'));
    document.getElementById('close-shop').addEventListener('click', ()=>closeModal('shop'));
  </script>
</body>
</html>
